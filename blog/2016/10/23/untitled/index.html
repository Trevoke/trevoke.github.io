<!DOCTYPE html>
<html lang="en-us">
  <head>
    <title>Untitled - Seven Steps</title>
    <meta charset="utf-8" />
    <meta name="author" content="Aldric Giacomoni" />
    <link rel="stylesheet" href="/media/css/main.css" type="text/css">
  </head>
  <body class="container">
    <div>
      <header class="masthead">
        <h1 class="masthead-title"><a href="/">Seven Steps</a></h1>
        <p>Words... words, they&#39;re all we have to go on! — Rosencrantz and Guildenstern are dead</p>
        <ul>
          <li><a href="/_drafts/">_Drafts</a></li>
          <li><a href="/blog/">Blog</a></li>
          <li><a href="/wip/">Wip</a></li>
          <li><a href="/tags/">Tags</a></li>
          <li><a href="/about/">About</a></li>
          <li><a href="https://github.com/trevoke">GitHub</a></li>
        </ul>
        <form method="get" id="searchform" action="http://www.google.com/search">
          <input type="text" class="field" name="q" id="s" placeholder="Search">
          <input type="hidden" name="q" value="site:blog.trevoke.net">
        </form>
      </header>
    </div>

<div>
<div class="post">
<h1>Untitled</h1>

<div id="outline-container-orgheadline1" class="outline-2">
<h2 id="orgheadline1">Sqlup.el : the story of the minor mode that could</h2>
<div class="outline-text-2" id="text-orgheadline1">
<p>
Or, how Ι stopped worrying and learned to love emacs
</p>

<p>
Because, why spend five minutes doing something you can spend ten years automating?
</p>
</div>
</div>
<div id="outline-container-orgheadline2" class="outline-2">
<h2 id="orgheadline2">Short intro to me</h2>
<div class="outline-text-2" id="text-orgheadline2">
<p>
I'm Aldric Giacomoni in meatspace
</p>

<p>
I'm Trevoke in cyberspace
</p>

<p>
Find me at trevoke@gmail.com
</p>

<p>
I study martial arts (this will soon makes sense)
</p>
</div>
<div id="outline-container-orgheadline3" class="outline-3">
<h3 id="orgheadline3">Emacs and me</h3>
<div class="outline-text-3" id="text-orgheadline3">
<p>
Because everyone's origin story can be instructive
</p>
</div>
</div>
</div>
<div id="outline-container-orgheadline4" class="outline-2">
<h2 id="orgheadline4">Friendly manual to this talk</h2>
<div class="outline-text-2" id="text-orgheadline4">
<p>
If you're just reading the slides, you'll see emacs functions.
Just use <code>C-h &lt;function-name&gt;</code> in emacs and seize the power.
</p>
</div>
</div>
<div id="outline-container-orgheadline5" class="outline-2">
<h2 id="orgheadline5">Short intro to modes</h2>
<div class="outline-text-2" id="text-orgheadline5">
<ul class="org-ul">
<li>One major mode</li>
<li>Many minor modes</li>
</ul>
</div>
</div>
<div id="outline-container-orgheadline6" class="outline-2">
<h2 id="orgheadline6">The simplest minor mode</h2>
<div class="outline-text-2" id="text-orgheadline6">
<div class="org-src-container">

<pre class="src src-emacs-lisp">(<span style="color: #597bc5;">define-minor-mode</span> <span style="color: #f9cf80;">miyagi-mode</span>
  <span style="color: #64783a;">"Teaches you martial arts without you even knowing it"</span>
  (<span style="color: #597bc5;">if</span> miyagi-mode
      (message <span style="color: #99ad6a;">"Wax on"</span>)
    (message <span style="color: #99ad6a;">"Wax off"</span>)))
</pre>
</div>
</div>
</div>
<div id="outline-container-orgheadline7" class="outline-2">
<h2 id="orgheadline7">How sqlup started</h2>
<div class="outline-text-2" id="text-orgheadline7">
<ul class="org-ul">
<li>There is a Right Way™ to write SQL</li>
<li>I'm <b>SO</b> lazy</li>
<li>Can't emacs do <i>EVERYTHING</i>?</li>
</ul>
</div>
</div>
<div id="outline-container-orgheadline8" class="outline-2">
<h2 id="orgheadline8">Enter The Friend</h2>
<div class="outline-text-2" id="text-orgheadline8">
<blockquote>
<p>
Oh sure, you just need a keyword list and you look back and see if the word is in the list.
</p>

<p>
— Eric Jones
</p>
</blockquote>
<p>
At this point, I knew exactly <b>nothing</b> of emacs-lisp.
</p>
</div>
</div>
<div id="outline-container-orgheadline9" class="outline-2">
<h2 id="orgheadline9">Implementation for v1</h2>
<div class="outline-text-2" id="text-orgheadline9">
<p>
This version took over the space and open-parens, and replaced the last word (emacs symbol, really) with its upcased counterpart if it was found in a list.
</p>
</div>
<div id="outline-container-orgheadline10" class="outline-3">
<h3 id="orgheadline10"><code>message</code></h3>
<div class="outline-text-3" id="text-orgheadline10">
<p>
It's Ye Olde Friendly Logger
</p>
<div class="org-src-container">

<pre class="src src-emacs-lisp">(message <span style="color: #99ad6a;">"Hello, world!"</span>)
</pre>
</div>
</div>
</div>
<div id="outline-container-orgheadline11" class="outline-3">
<h3 id="orgheadline11"><code>thing-at-point</code></h3>
<div class="outline-text-3" id="text-orgheadline11">
<p>
It returns the kind of thing… at point… that you specify
</p>
<div class="org-src-container">

<pre class="src src-emacs-lisp">(thing-at-point 'symbol)
</pre>
</div>
</div>
</div>
<div id="outline-container-orgheadline12" class="outline-3">
<h3 id="orgheadline12"><code>bounds-of-thing-at-point</code></h3>
<div class="outline-text-3" id="text-orgheadline12">
<p>
A cons cell with the buffer position for start and end of… Thing… At point…
</p>
<div class="org-src-container">

<pre class="src src-emacs-lisp">(bounds-of-thing-at-point 'symbol)
</pre>
</div>
</div>
</div>
<div id="outline-container-orgheadline13" class="outline-3">
<h3 id="orgheadline13"><code>interactive</code></h3>
<div class="outline-text-3" id="text-orgheadline13">
<p>
This function is used to tell emacs that you're writing an extended command (<code>M-x miyagi</code>)
</p>
<div class="org-src-container">

<pre class="src src-emacs-lisp">(<span style="color: #597bc5;">defun</span> <span style="color: #f9cf80;">miyagi</span> ()
  (<span style="color: #597bc5;">interactive</span>)
  (message <span style="color: #99ad6a;">"Show me&#8230; Paint the fence!"</span>))
</pre>
</div>
</div>
</div>
<div id="outline-container-orgheadline14" class="outline-3">
<h3 id="orgheadline14">The meat of it</h3>
<div class="outline-text-3" id="text-orgheadline14">
<div class="org-src-container">

<pre class="src src-emacs-lisp">(<span style="color: #597bc5;">setq</span> current-word-upcase (upcase (thing-at-point 'symbol)))
(<span style="color: #597bc5;">setq</span> current-word-boundaries (bounds-of-thing-at-point 'symbol))
(delete-region
  (car current-word-boundaries)
  (cdr current-word-boundaries))
(insert current-word-upcase)
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-orgheadline15" class="outline-2">
<h2 id="orgheadline15">Flaws with v1</h2>
<div class="outline-text-2" id="text-orgheadline15">
<ul class="org-ul">
<li><code>insert</code> for space and open-parens</li>
</ul>
<div class="org-src-container">

<pre class="src src-emacs-lisp">(insert <span style="color: #99ad6a;">"a"</span>)
</pre>
</div>
<ul class="org-ul">
<li>limited matching capability (just strings)</li>
</ul>
</div>
</div>
<div id="outline-container-orgheadline16" class="outline-2">
<h2 id="orgheadline16">"Batch mode"</h2>
<div class="outline-text-2" id="text-orgheadline16">
<p>
I added a function to capitalize SQL keywords in a region.
</p>
</div>
<div id="outline-container-orgheadline17" class="outline-3">
<h3 id="orgheadline17"><code>while</code></h3>
<div class="outline-text-3" id="text-orgheadline17">
<div class="org-src-container">

<pre class="src src-emacs-lisp">(<span style="color: #597bc5;">while</span>
    true
  (message <span style="color: #99ad6a;">"Oh good, a `while true` loop."</span>))
</pre>
</div>
</div>
</div>
<div id="outline-container-orgheadline18" class="outline-3">
<h3 id="orgheadline18"><code>search-forward-regexp</code></h3>
<div class="outline-text-3" id="text-orgheadline18">
<p>
With <code>replace-match</code>
</p>
<div class="org-src-container">

<pre class="src src-emacs-lisp">(search-forward-regexp <span style="color: #99ad6a;">"[[:alpha:]_]+"</span> (point-max))
(replace-match <span style="color: #99ad6a;">"Miyagi!"</span>)
</pre>
</div>
</div>
</div>
<div id="outline-container-orgheadline19" class="outline-3">
<h3 id="orgheadline19"><code>save-excursion</code></h3>
<div class="outline-text-3" id="text-orgheadline19">
<div class="org-src-container">

<pre class="src src-emacs-lisp"><span style="color: #adadad; font-style: italic;">;; </span><span style="color: #adadad; font-style: italic;">In Okinawa, belt mean no need rope to hold up pants.</span>
(<span style="color: #597bc5;">save-excursion</span>
  (goto-char (point-min))
  (<span style="color: #597bc5;">while</span> (search-forward-regexp <span style="color: #99ad6a;">"rope"</span> (point-max) t)
  (replace-match <span style="color: #99ad6a;">"belt"</span>)))
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-orgheadline20" class="outline-2">
<h2 id="orgheadline20">Implementation for v2</h2>
<div class="outline-text-2" id="text-orgheadline20">
<p>
Now sqlup uses a post-command hook, working directly with emacs' event loop.
</p>
</div>
<div id="outline-container-orgheadline21" class="outline-3">
<h3 id="orgheadline21"><code>post-command-hook</code></h3>
<div class="outline-text-3" id="text-orgheadline21">
<div class="org-src-container">

<pre class="src src-emacs-lisp"><span style="color: #adadad; font-style: italic;">;; </span><span style="color: #adadad; font-style: italic;">The fourth argument means "buffer-local" if non-nil</span>
(add-hook 'post-command-hook 'do-something nil t)
</pre>
</div>
<p>
Arguable choice. Runs ALL THΕ TIME. So, early guard clauses are imperative.
</p>
<div class="org-src-container">

<pre class="src src-emacs-lisp">(<span style="color: #597bc5;">defun</span> <span style="color: #f9cf80;">sqlup-should-do-work-p</span> ()
  (<span style="color: #597bc5;">or</span> (sqlup-user-pressed-returnp)
      (<span style="color: #597bc5;">and</span> (sqlup-user-is-typingp)
           (sqlup-trigger-self-insert-characterp))))
</pre>
</div>
</div>
</div>
<div id="outline-container-orgheadline22" class="outline-3">
<h3 id="orgheadline22"><code>this-command-keys-vector</code></h3>
<div class="outline-text-3" id="text-orgheadline22">
<div class="org-src-container">

<pre class="src src-emacs-lisp">(<span style="color: #597bc5;">defun</span> <span style="color: #f9cf80;">sqlup-user-pressed-return-p</span> ()
  (equal 13 (elt (this-command-keys-vector) 0)))
</pre>
</div>
</div>
</div>
<div id="outline-container-orgheadline23" class="outline-3">
<h3 id="orgheadline23"><code>symbol-name</code> with <code>this-command</code></h3>
<div class="outline-text-3" id="text-orgheadline23">
<div class="org-src-container">

<pre class="src src-emacs-lisp">(<span style="color: #597bc5;">defun</span> <span style="color: #f9cf80;">sqlup-user-is-typing-p</span> ()
  (string= <span style="color: #99ad6a;">"self-insert-command"</span> (symbol-name this-command)))
</pre>
</div>
</div>
</div>
<div id="outline-container-orgheadline24" class="outline-3">
<h3 id="orgheadline24">Oh yeah, also leverage <code>sql-mode</code> !</h3>
<div class="outline-text-3" id="text-orgheadline24">
<div class="org-src-container">

<pre class="src src-emacs-lisp">(sql-add-product-keywords 'ansi '())
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-orgheadline27" class="outline-2">
<h2 id="orgheadline27">Required tweaks for v2</h2>
<div class="outline-text-2" id="text-orgheadline27">
</div><div id="outline-container-orgheadline25" class="outline-3">
<h3 id="orgheadline25">Only pull SQL keywords from <code>sql-mode</code> if not already defined</h3>
</div>
<div id="outline-container-orgheadline26" class="outline-3">
<h3 id="orgheadline26">Pull the correct keywords</h3>
<div class="outline-text-3" id="text-orgheadline26">
<div class="org-src-container">

<pre class="src src-emacs-lisp">(<span style="color: #597bc5;">defun</span> <span style="color: #f9cf80;">sqlup-find-correct-keywords</span> ()
  (<span style="color: #597bc5;">if</span> (<span style="color: #597bc5;">and</span> (boundp 'sql-mode-font-lock-keywords)
           sql-mode-font-lock-keywords)
      (mapcar 'car sql-mode-font-lock-keywords)
    (mapcar 'car (sql-add-product-keywords
                  (<span style="color: #597bc5;">or</span> (<span style="color: #597bc5;">and</span> (boundp 'sql-product) sql-product)
                      'ansi) <span style="color: #dd0093;">'()))))</span>
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-orgheadline28" class="outline-2">
<h2 id="orgheadline28">Lesson learned</h2>
<div class="outline-text-2" id="text-orgheadline28">
<p>
This looks so simple NOW.
</p>
<div class="org-src-container">

<pre class="src src-emacs-lisp">(<span style="color: #597bc5;">defun</span> <span style="color: #f9cf80;">sqlup-maybe-capitalize-last-symbol</span> ()
  (forward-symbol -1)
  (sqlup-work-on-symbol-at-point))
</pre>
</div>
</div>
</div>

<div id="outline-container-orgheadline29" class="outline-2">
<h2 id="orgheadline29">Lesson learned</h2>
<div class="outline-text-2" id="text-orgheadline29">
<p>
Wait, emacs can do WHAT?
</p>
<div class="org-src-container">

<pre class="src src-emacs-lisp">(<span style="color: #597bc5;">defun</span> <span style="color: #f9cf80;">sqlup-comment-p</span> (line)
  (<span style="color: #597bc5;">and</span>
   (nth 4 (syntax-ppss))
   t))
</pre>
</div>
<p>
Trust me. Write down <code>syntax-ppss</code> and look it up.
</p>
</div>
</div>
<div id="outline-container-orgheadline30" class="outline-2">
<h2 id="orgheadline30"><code>syntax-ppss</code>..</h2>
<div class="outline-text-2" id="text-orgheadline30">
<p>
Okay, so if you've looked up <code>syntax-ppsss</code>...
</p>

<p>
It doesn't work if the major-mode is not right.
</p>

<p>
So .... V3, coming next ........ Is a hack
</p>
</div>
</div>
<div id="outline-container-orgheadline31" class="outline-2">
<h2 id="orgheadline31">V3?! emacs is SO POWERFUL!</h2>
<div class="outline-text-2" id="text-orgheadline31">
<p>
Here's the hack.
</p>
<div class="org-src-container">

<pre class="src src-emacs-lisp">(<span style="color: #597bc5;">defun</span> <span style="color: #f9cf80;">sqlup-capitalizable-p</span> (point-location)
  (<span style="color: #597bc5;">let</span> ((old-buffer (current-buffer)))
    (<span style="color: #597bc5;">with-temp-buffer</span>
      (insert-buffer-substring old-buffer)
      (sql-mode)
      (goto-char point-location)
      (<span style="color: #597bc5;">and</span> (not (sqlup-commentp))
           (not (sqlup-stringp))))))
</pre>
</div>
<p>
This is the implementation I'm <b>most</b> ashamed of.
</p>
</div>
</div>
<div id="outline-container-orgheadline32" class="outline-2">
<h2 id="orgheadline32">v .. 3.5 ? redis</h2>
<div class="outline-text-2" id="text-orgheadline32">
<p>
I got a request for redis-mode support.
</p>

<p>
Luckily, redis-mode provides a list of keywords.
</p>
</div>
<div id="outline-container-orgheadline33" class="outline-3">
<h3 id="orgheadline33">Ze Code</h3>
<div class="outline-text-3" id="text-orgheadline33">
<div class="org-src-container">

<pre class="src src-emacs-lisp">(<span style="color: #597bc5;">defun</span> <span style="color: #f9cf80;">sqlup-find-correct-keywords</span> ()
  (<span style="color: #597bc5;">cond</span> ((sqlup-redis-mode-p) (mapcar 'downcase redis-keywords))
        ((sqlup-within-sql-buffer-p) (mapcar 'car sql-mode-font-lock-keywords))
        (t (mapcar 'car (sql-add-product-keywords
                         (<span style="color: #597bc5;">or</span> (<span style="color: #597bc5;">and</span> (boundp 'sql-(point)roduct) sql-product)
                             'ansi) <span style="color: #dd0093;">'())))))</span>

(<span style="color: #597bc5;">defun</span> <span style="color: #f9cf80;">sqlup-redis-mode-p</span> ()
  (string= (<span style="color: #597bc5;">with-current-buffer</span> (current-buffer) major-mode)
           <span style="color: #99ad6a;">"redis-mode"</span>))
</pre>
</div>
</div>
</div>
</div>

</div>
</div>
    <div>
      <div class="post-meta">
        <span title="post date" class="post-info">2016-10-23</span>
        <span title="last modification date" class="post-info">2016-06-02</span>
        <span title="tags" class="post-info">N/A</span>
        <span title="author" class="post-info">Aldric Giacomoni</span>
      </div>
      <section>
        <h1>Comments</h1>
        <div id="disqus_thread"></div>
        <script type="text/javascript">
          //var disqus_developer = 1;
          var disqus_identifier = "/blog/2016/10/23/untitled/";
          var disqus_url = "http://blog.trevoke.net/blog/2016/10/23/untitled/";
          var disqus_shortname = 'seven-steps';
          /* * * DON'T EDIT BELOW THIS LINE * * */
          (function() {
          var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
          dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
          (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
          })();
        </script>
        <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
        <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
      </section>
      <script type="text/javascript">
        var _gaq = _gaq || [];
        _gaq.push(['_setAccount', 'UA-2479931-6']);
        _gaq.push(['_trackPageview']);
        (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
        })();
      </script>
      <div class="footer">
        <p>Generated by <a href="http://www.gnu.org/software/emacs/">Emacs</a> 25.1.1 (<a href="http://orgmode.org">Org</a> mode 8.2.10)</p>
        <p>
          Copyright &copy; 2012 - 2013 <a href="mailto:trevoke &lt;at&gt; gmail &lt;dot&gt; com">Aldric Giacomoni</a>
          &nbsp;&nbsp;-&nbsp;&nbsp;
          Powered by <a href="https://github.com/kelvinh/org-page" target="_blank">org-page</a>
        </p>
      </div>
    </div>
  </body>
</html>
