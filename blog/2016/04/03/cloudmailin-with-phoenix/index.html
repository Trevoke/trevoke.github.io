<!DOCTYPE html>
<html lang="en-us">
  <head>
    <title>CloudMailIn with Phoenix - Seven Steps</title>
    <meta charset="utf-8" />
    <meta name="author" content="Aldric Giacomoni" />
    <meta name="description" content="What CloudMailIn looks like when the request gets to Phoenix" />
    <meta name="keywords" content="phoenix, elixir, email, cloudmailin" />
    <link rel="stylesheet" href="/media/css/main.css" type="text/css">
  </head>
  <body class="container">
    <div>
      <header class="masthead">
        <h1 class="masthead-title"><a href="/">Seven Steps</a></h1>
        <p>Words... words, they&#39;re all we have to go on! — Rosencrantz and Guildenstern are dead</p>
        <ul>
          <li><a href="/_drafts/">_Drafts</a></li>
          <li><a href="/blog/">Blog</a></li>
          <li><a href="/wip/">Wip</a></li>
          <li><a href="/tags/">Tags</a></li>
          <li><a href="/about/">About</a></li>
          <li><a href="https://github.com/trevoke">GitHub</a></li>
        </ul>
        <form method="get" id="searchform" action="http://www.google.com/search">
          <input type="text" class="field" name="q" id="s" placeholder="Search">
          <input type="hidden" name="q" value="site:blog.trevoke.net">
        </form>
      </header>
    </div>

<div>
<div class="post">
<h1>CloudMailIn with Phoenix</h1>
<p>
Short and sweet, the params when they get to Phoenix look like:
</p>

<div class="org-src-container">

<pre class="src src-elixir">%{<span style="color: #99ad6a;">"envelope"</span> =&gt; %{<span style="color: #99ad6a;">"from"</span> =&gt; <span style="color: #99ad6a;">"email-sender@anon.com"</span>,
    <span style="color: #99ad6a;">"helo_domain"</span> =&gt; <span style="color: #99ad6a;">"mail-ig0-f180.google.com"</span>,
    <span style="color: #99ad6a;">"recipients"</span> =&gt; %{<span style="color: #99ad6a;">"0"</span> =&gt; <span style="color: #99ad6a;">"anonymized_email@cloudmailin.net"</span>},
    <span style="color: #99ad6a;">"remote_ip"</span> =&gt; <span style="color: #99ad6a;">"209.85.213.180"</span>,
    <span style="color: #99ad6a;">"spf"</span> =&gt; %{<span style="color: #99ad6a;">"domain"</span> =&gt; <span style="color: #99ad6a;">"gmail.com"</span>, <span style="color: #99ad6a;">"result"</span> =&gt; <span style="color: #99ad6a;">"neutral"</span>},
    <span style="color: #99ad6a;">"to"</span> =&gt; <span style="color: #99ad6a;">"anonymized_email@cloudmailin.net"</span>},
  <span style="color: #99ad6a;">"headers"</span> =&gt; %{<span style="color: #99ad6a;">"DKIM-Signature"</span> =&gt; <span style="color: #99ad6a;">"v=1; a=rsa-sha256; c=relaxed/relaxed; d=gmail.com; s=20120113; h=mime-version:references:in-reply-to:from:date:message-id:subject:to; bh=NhQC5Y4GtndvGS3lzmW4g8NmFWYjaV+sLM17QKhijEc=; b=VabUB6nyFC6cwPdLPlGjhhSyr8vPtY8FMbRo3S+vJM6SDV+NuYrH7tJVxPRGMO4GiC poUhLqeTKSNx3mdA8uYCmmFsmS7gzTf/Mm645CyTKXT/utUVW9WhFI+tNMfLRLaN7CNu mrE/nvWQmjvvvx2PhkH72d4InTkO6L5lBSsUNwD22VQ7T1pE7jAuAe0rh1JWQyuNR12W wao4IBwShKG62G7OUO1whk8WqhDqKVOShILV2bIX8/5Wbv6UXpgwGi1FPdwwrECLqHWn xdp+7oPHlqWKcQPvRksoF/P1t7jgTVcdqSwFbh341syiVq6R/GDytZMBT7a6N2EqoHt7 sHpA=="</span>,
    <span style="color: #99ad6a;">"Date"</span> =&gt; <span style="color: #99ad6a;">"Sun, 03 Apr 2016 16:46:29 +0000"</span>,
    <span style="color: #99ad6a;">"From"</span> =&gt; <span style="color: #99ad6a;">"some-sender@where.com"</span>,
    <span style="color: #99ad6a;">"In-Reply-To"</span> =&gt; <span style="color: #99ad6a;">"<a href="mailto:id%40mail.gmail.com">&lt;id@mail.gmail.com&gt;</a>"</span>,
    <span style="color: #99ad6a;">"Message-ID"</span> =&gt; <span style="color: #99ad6a;">"<a href="mailto:msgid%40mail.gmail.com">&lt;msgid@mail.gmail.com&gt;</a>"</span>,
    <span style="color: #99ad6a;">"Mime-Version"</span> =&gt; <span style="color: #99ad6a;">"1.0"</span>,
    <span style="color: #99ad6a;">"Received"</span> =&gt; <span style="color: #99ad6a;">"by mail-ig0-f180.google.com with SMTP id ui10so47872593igc.1 for <a href="mailto:anonymized_email%40cloudmailin.net">&lt;anonymized_email@cloudmailin.net&gt;</a>; Sun, 03 Apr 2016 09:46:39 -0700"</span>,
    <span style="color: #99ad6a;">"References"</span> =&gt; <span style="color: #99ad6a;">"<a href="mailto:idQ%40mail.gmail.com">&lt;idQ@mail.gmail.com&gt;</a>"</span>,
    <span style="color: #99ad6a;">"Subject"</span> =&gt; <span style="color: #99ad6a;">"Re: TestSatNight"</span>,
    <span style="color: #99ad6a;">"To"</span> =&gt; <span style="color: #99ad6a;">"\"anonymized_email@cloudmailin.net\" <a href="mailto:e448577c412a059d1937%40cloudmailin.net">&lt;e448577c412a059d1937@cloudmailin.net&gt;</a>"</span>,
    <span style="color: #99ad6a;">"X-Gm-Message-State"</span> =&gt; <span style="color: #99ad6a;">"somethinghere"</span>,
    <span style="color: #99ad6a;">"X-Google-DKIM-Signature"</span> =&gt; <span style="color: #99ad6a;">"v=1; a=rsa-sha256; c=relaxed/relaxed; d=1e100.net; s=20130820; h=x-gm-message-state:mime-version:references:in-reply-to:from:date :message-id:subject:to; bldsadklasjdksasdjklasdjkas"</span>,
    <span style="color: #99ad6a;">"X-Received"</span> =&gt; <span style="color: #99ad6a;">"by 10.50.30.101 with SMTP id r5mr7754024igh.2.1459701998613; Sun, 03 Apr 2016 09:46:38 -0700 (PDT)"</span>},
  <span style="color: #99ad6a;">"html"</span> =&gt; <span style="color: #99ad6a;">"&lt;div dir=\"ltr\"&gt;Okay okay okay foobar&lt;br&gt;&lt;br&gt;&lt;div class=\"gmail_quote\"&gt;&lt;div dir=\"ltr\"&gt;On Sat, Apr 2, 2016 at 11:12 PM Someone &amp;lt;&lt;a href=\"me@gmail\"&gt;me@gmail.com&lt;/a&gt;&amp;gt; wrote:&lt;br&gt;&lt;/div&gt;&lt;blockquote class=\"gmail_quote\" style=\"margin:0 0 0 .8ex;border-left:1px #ccc solid;padding-left:1ex\"&gt;&lt;div dir=\"ltr\"&gt;BodyTest&lt;/div&gt;&lt;/blockquote&gt;&lt;/div&gt;&lt;/div&gt;\n"</span>,
  <span style="color: #99ad6a;">"plain"</span> =&gt; <span style="color: #99ad6a;">"Okay okay okay foobar\n\nOn Sat, Apr 2, 2016 at 11:12 PM Someone <a href="mailto:some%40one.com">&lt;some@one.com&gt;</a> wrote:\n\n&gt; BodyTest\n&gt;\n"</span>,
  <span style="color: #99ad6a;">"reply_plain"</span> =&gt; <span style="color: #99ad6a;">"Okay okay okay foobar"</span>}
</pre>
</div>

<p>
So if you're in Phoenix, one way you could do a sanity check is like this
</p>

<p>
You set up a mini-pipeline based on HTML — this is optional — in the router, like so:
</p>

<p>
Whereas in the router, you'd have this:
</p>
<div class="org-src-container">

<pre class="src src-elixir"><span style="color: #adadad; font-style: italic;"># </span><span style="color: #adadad; font-style: italic;">web/router.ex</span>
  pipeline <span style="color: #87cefa;">:mail</span> <span style="color: #597bc5;">do</span>
    plug <span style="color: #87cefa;">:accepts</span>, [<span style="color: #99ad6a;">"html"</span>]
    plug <span style="color: #87cefa;">:fetch_session</span>
    plug <span style="color: #87cefa;">:fetch_flash</span>
  <span style="color: #597bc5;">end</span>

  scope <span style="color: #99ad6a;">"/mail"</span>, <span style="color: #fdb86b;">MyApp</span> <span style="color: #597bc5;">do</span>
    pipe_through <span style="color: #87cefa;">:mail</span>
    post <span style="color: #99ad6a;">"/"</span>, <span style="color: #fdb86b;">MailController</span>, <span style="color: #87cefa;">:create</span>
  <span style="color: #597bc5;">end</span>
</pre>
</div>

<p>
And then you can use a controller like this:
</p>
<div class="org-src-container">

<pre class="src src-elixir"><span style="color: #adadad; font-style: italic;"># </span><span style="color: #adadad; font-style: italic;">web/controllers/mail_controller.ex</span>
<span style="color: #597bc5;">defmodule</span> <span style="color: #fdb86b;">MyApp.MailController</span> <span style="color: #597bc5;">do</span>
  <span style="color: #597bc5;">use</span> <span style="color: #fdb86b;">MyApp.Web</span>, <span style="color: #87cefa;">:controller</span>
  <span style="color: #597bc5;">require</span> <span style="color: #fdb86b;">Logger</span>

  <span style="color: #597bc5;">def</span> <span style="color: #f9cf80;">create</span>(conn, params) <span style="color: #597bc5;">do</span>
    <span style="color: #c6b8fc;">foo</span> = params[<span style="color: #99ad6a;">"headers"</span>][<span style="color: #99ad6a;">"Subject"</span>]
    <span style="color: #c6b8fc;">bar</span> = <span style="color: #597bc5;">if</span>(<span style="color: #fdb86b;">String</span>.length(params[<span style="color: #99ad6a;">"reply_plain"</span>]) == 0) <span style="color: #597bc5;">do</span>
      params[<span style="color: #99ad6a;">"plain"</span>]
    <span style="color: #597bc5;">else</span>
      params[<span style="color: #99ad6a;">"reply_plain"</span>]
    <span style="color: #597bc5;">end</span>
    <span style="color: #c6b8fc;">date</span> = params[<span style="color: #99ad6a;">"headers"</span>][<span style="color: #99ad6a;">"Date"</span>]

    render conn, <span style="color: #87cefa;">:ok</span>
  <span style="color: #597bc5;">end</span>
<span style="color: #597bc5;">end</span>
</pre>
</div>


<p>
I don't actually know how to properly log a struct (I'm <b>that</b> new to Elixir that I don't know how to pretty-print a struct, I suppose), but you could always use IEx: in the controller, <code>require IEx</code> and in the action, <code>IEx.pry</code>, then go nuts.
</p>

</div>
</div>
    <div>
      <div class="post-meta">
        <span title="post date" class="post-info">2016-04-03</span>
        <span title="last modification date" class="post-info">2016-05-22</span>
        <span title="tags" class="post-info"><a href="/tags/cloudmailin/">cloudmailin</a>, <a href="/tags/phoenix/">phoenix</a>, <a href="/tags/elixir/">elixir</a></span>
        <span title="author" class="post-info">Aldric Giacomoni</span>
      </div>
      <section>
        <h1>Comments</h1>
        <div id="disqus_thread"></div>
        <script type="text/javascript">
          //var disqus_developer = 1;
          var disqus_identifier = "/blog/2016/04/03/cloudmailin-with-phoenix";
          var disqus_url = "http://blog.trevoke.net/blog/2016/04/03/cloudmailin-with-phoenix";
          var disqus_shortname = 'seven-steps';
          /* * * DON'T EDIT BELOW THIS LINE * * */
          (function() {
          var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
          dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
          (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
          })();
        </script>
        <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
        <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
      </section>
      <script type="text/javascript">
        var _gaq = _gaq || [];
        _gaq.push(['_setAccount', 'UA-2479931-6']);
        _gaq.push(['_trackPageview']);
        (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
        })();
      </script>
      <div class="footer">
        <p>Generated by <a href="http://www.gnu.org/software/emacs/">Emacs</a> 25.1.1 (<a href="http://orgmode.org">Org</a> mode 8.2.10)</p>
        <p>
          Copyright &copy; 2012 - 2013 <a href="mailto:trevoke &lt;at&gt; gmail &lt;dot&gt; com">Aldric Giacomoni</a>
          &nbsp;&nbsp;-&nbsp;&nbsp;
          Powered by <a href="https://github.com/kelvinh/org-page" target="_blank">org-page</a>
        </p>
      </div>
    </div>
  </body>
</html>
